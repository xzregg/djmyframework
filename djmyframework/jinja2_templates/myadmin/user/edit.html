{% extends "framework/base.html" %}
{#{% load i18n %}#}
{% block header %}
    <title>{{ _('管理员模型 编辑') }}</title>
{% endblock %}


{% block content %}
    <div id="vue-container" v-cloak>
        <div class="row header">
            <div class="col-sm-5">
                <h1>{{ _('管理员模型') }}
                    <small>{{ _('编辑') }}</small>
                </h1>
            </div>
        </div>

        <hr>
        <br>

        <form class="form-horizontal" role="form">

            <div class="row edit-container">
                <div class="col-sm-6">
                    {{ csrf_input }}
                    <div class="form-group" style="display:none">
                        <label class="col-sm-3 control-label no-padding-right" for="id_id">
                            {{ _('id') }} </label>

                        <div class="col-sm-8">
                            <input type="number" id="id_id" name="id"
                                   class="form-control" value="{{ data.id  or "" }}"
                            >

                            <div id="help_text_id" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_alias">
                            {{ _('别名(姓名)') }} <span class="text-danger">*</span></label>

                        <div class="col-sm-8">
                            <input type="text" id="id_alias" name="alias"
                                   class="form-control" value="{{ data.alias  or "" }}"
                                   maxlength=50
                                   required=true
                            >

                            <div id="help_text_alias" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_username">
                            {{ _('用户名(登录名)') }} <span class="text-danger">*</span></label>

                        <div class="col-sm-8">
                            <input type="text" id="id_username" name="username"
                                   class="form-control" value="{{ data.username  or "" }}"
                                   maxlength=50
                                   required=true
                            >

                            <div id="help_text_username" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_password">
                            {{ _('密码') }} <span class="text-danger">*</span></label>

                        <div class="col-sm-8">
                            <input type="text" id="id_password" name="password"
                                   class="form-control" value="{{ data.password  or "" }}"
                                   maxlength=32
                                   required=true
                            >

                            <div id="help_text_password" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_last_ip">
                            {{ _('最后登录ip') }} </label>

                        <div class="col-sm-8">
                            <input type="text" id="id_last_ip" name="last_ip"
                                   class="form-control" value="{{ data.last_ip  or "" }}"
                                   maxlength=20

                            >

                            <div id="help_text_last_ip" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_last_time">
                            {{ _('最后登录时间') }} </label>

                        <div class="col-sm-8">

                            <input type="text" id="id_last_time" name="last_time"
                                   class="form-control datetime " value="{{ data.last_time   or "" }}"

                            >

                            <div id="help_text_last_time" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_login_count">
                            {{ _('登录次数') }} </label>

                        <div class="col-sm-8">
                            <input type="number" id="id_login_count" name="login_count"
                                   class="form-control" value="{{ data.login_count  or "" }}"


                            >

                            <div id="help_text_login_count" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_status">
                            {{ _('状态') }} </label>

                        <div class="col-sm-8">
                            <select class="form-control col-lg-5 select2" id="id_status"
                                    data-placeholder="{{ _('状态') }}" name="status" svalue="{{ data.status }}">
                                {% for o in data.serializer.instance.fields_map.status.choices %}
                                    <option value="{{ o.0 }}">{{ o.1 }}</option>
                                {% endfor %}

                            </select>

                            <div id="help_text_status" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                    {#                <div class="form-group" style="">#}
                    {#                    <label class="col-sm-3 control-label no-padding-right" for="id_session_key">#}
                    {#                        {{ _('会话key') }} </label>#}
                    {##}
                    {#                    <div class="col-sm-8">#}
                    {#                        <input type="text" id="id_session_key" name="session_key"#}
                    {#                               class="form-control" value="{{ data.session_key  or "" }}"#}
                    {#                               maxlength=40#}
                    {##}
                    {#                        >#}
                    {##}
                    {#                        <div id="help_text_session_key" class="middle text-danger help_text"></div>#}
                    {#                    </div>#}
                    {#                </div>#}


                    <div class="form-group" style="">
                        <label class="col-sm-3 control-label no-padding-right" for="id_create_datetime">
                            {{ _('创建时间') }} </label>

                        <div class="col-sm-8">

                            <input type="text" id="id_create_datetime" name="create_datetime"
                                   class="form-control datetime "
                                   value="{{ data.create_datetime   or "" }}"

                            >

                            <div id="help_text_create_datetime" class="middle text-danger help_text"></div>
                        </div>
                    </div>


                </div>

                <div class="col-sm-6">
                    <div class="tabbable ">
                        <ul class="nav nav-tabs padding-12 ">
                            <li class="active">
                                <a data-toggle="tab" href="#tab1">
                                    <i class="icon-dashboard bigger-110"></i>{{ _('所属角色') }}
                                </a>
                            </li>


                        </ul>

                        <div class="tab-content">

                            <div id="tab1" class="tab-pane active">

                                <div class="">


                                    <bootstrap-table :columns="columns" ref="table" :options="options"
                                                     @onPostBody="onPostBody"></bootstrap-table>

                                </div>

                            </div>


                        </div>
                    </div>

                </div>
            </div>


            <div class="row pane edit-save-bar">
                <div class="col-sm-offset-3 col-sm-9">
                    <input id="reset-btn" class="btn btn-default" type="reset" value="{{ _('重 置') }}">
                    <button @click="saveModel(true)" :disabled="isExecuting" class="btn btn-primary " type="button">
                        {{ _('保 存') }}
                    </button>

                    <div class="pull-right">
                        <button @click="saveModel(false)" :disabled="isExecuting" class="btn btn-info " type="button">
                            {{ _('保存并继续编辑') }}
                        </button>
                        <button @click="saveModelAddOther" :disabled="isExecuting" class="btn btn-info " type="button">
                            {{ _('保存并增加另一个') }}
                        </button>
                    </div>
                </div>
            </div>
        </form>

    </div>

    <script>
        var modelData = Object({{ data|json_dumps|safe }})

        var modelShema = Object({{ data.serializer.to_schema()|json_dumps|safe }})


        var vue_app = new Vue({
            el: '#vue-container',
            components: {
                'BootstrapTable': BootstrapTable
            },
            delimiters: ['((', '))'],
            data() {
                return {
                    model: modelData,
                    isExecuting: false,
                    columns: [
                        {
                            checkbox: true,
                            align: 'center',
                            valign: 'middle',
                            width: 40,
                        }, {
                            field: 'alias',
                            title: "{{ _('角色') }}",
                            align: 'middle',
                            valign: 'middle',
                            sortable: false,
                            visible: true,
                        }, {
                            field: 'parent',
                            title: "{{ _('上级') }}",
                            align: 'center',
                            valign: 'middle',
                            sortable: true,
                            visible: false,
                        }],
                    options: {
                        url: "/myadmin/role/list?fields=id,type_alias,alias,parent&page_size=10000",
                      //  height: 400,
                        striped: true,
                        selectItemName: 'role',//checkbox name
                        // multipleSelectRow: true,
                        uniqueId: 'id',
                        filterControl: false,
                        search: true,
                        showSearchClearButton: true,
                        pagination: false,
                        trimOnSearch: true,
                        clickToSelect: true,
                        showRefresh: true, //是否显示刷新按钮
                        totalField: 'count',
                        dataField: 'results',
                        responseHandler: function (res) {
                            return res.data
                        },
                        groupBy: true,//分组
                        groupByField: 'type_alias',
                        // 表格树设置
                        idField: 'id',
                        treeEnable: true,
                        treeShowField: 'alias',//在哪一列展开树形
                        parentIdField: 'parent',
                        //rootParentId:'null',
                        showExport:false,

                    },
                    onPostBody: function (data) {
                        console.dir(this.$refs.role_table)
                        {#//this.$refs.role_table.checkBy( {field: 'id', values: {{ data.role|json_dumps }} } )#}
                    },

                };
            },
            watch: {},
            methods: {
                ajaxPostData: function (post_data, callback) {
                    clearHelpText()
                    this.isExecuting = true
                    $.ajax({
                        async: true,
                        type: "POST",
                        url: "{{ url('myadmin.user.save') }}?{% if data.id %}id={{ data.id }}{% endif %}{% if request.query_params.is_copy %}&is_copy=1{% endif %}",
                        dataType: 'json',
                        data: JSON.stringify(post_data),
                        contentType: 'application/json',
                        success: (rsp) => {
                            if (rsp.code == 0) {
                                this.$message.success(rsp.msg, 1)
                                clearHelpText()
                                callback ? callback(rsp) : null

                            } else {
                                rsp.data ? addHelpText(rsp.data) : alertMsg(rsp.msg)
                            }
                        },
                        error: (jqXHR, statusText, errorMsg) => {
                            ajaxError(jqXHR, statusText, errorMsg)

                        },
                        complete: (jqXHR, statusText) => {
                            this.isExecuting = false
                        }

                    })
                },
                saveModel: function (isCloseDialog) {
                    this.ajaxPostData(this.model, (rsp) => {
                        if (rsp.code == 0) {
                            this.model = rsp.data
                            refreshParentTable()
                            customDispatchEvent('saveModel', this.model, true)
                            if (isCloseDialog) closeSelfDialog()
                        }
                    })
                },
                saveModelAddOther: function () {
                    this.ajaxPostData(this.model, (rsp) => {
                        if (rsp.code == 0) {
                            window.location.href = window.location.pathname
                        }
                    })
                },

            },
            mounted: function () {


            }
        })


    </script>



{% endblock %}
